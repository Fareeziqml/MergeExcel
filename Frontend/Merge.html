<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Merge Excel — ILoveExcel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
      /* Excel-like gradient background */
      body {
        background: linear-gradient(to bottom right, #e8f5e9, #f9fff9);
      }

      /* Green accent buttons */
      .btn-green {
        background-color: #217346;
        color: white;
        transition: all 0.2s ease-in-out;
      }

      .btn-green:hover {
        background-color: #1a5b36;
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(33, 115, 70, 0.3);
      }

      /* Excel glow border */
      .excel-card {
        border: 1px solid #c8e6c9;
        box-shadow: 0 2px 10px rgba(33, 115, 70, 0.1);
      }

      /* Excel green text and icons */
      .excel-green {
        color: #217346;
      }

      /* Smooth fade animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .fade-in {
        animation: fadeIn 0.5s ease forwards;
      }

      /* Floating icon animation */
      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-6px);
        }
      }
    </style>
  </head>

  <body class="text-gray-800 font-[Inter] fade-in">
    <!-- Header -->
    <header
      class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-10 border-b border-green-100"
    >
      <div
        class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center"
      >
        <h1 class="text-2xl font-extrabold excel-green">💚 ILoveExcel</h1>
        <nav
          class="space-x-5 text-sm font-semibold flex flex-wrap justify-center"
        >
          <a href="index.html" class="hover:text-green-700 transition">Home</a>
          <a
            href="merge.html"
            class="text-green-700 underline underline-offset-4"
            >Merge</a
          >
          <a href="split.html" class="hover:text-green-700 transition">Split</a>
          <a href="convert.html" class="hover:text-green-700 transition"
            >Convert</a
          >
          <a href="clean.html" class="hover:text-green-700 transition">Clean</a>
          <a href="combine-analyze.html" class="hover:text-green-700 transition"
            >Combine + Analyze</a
          >
          <a href="EditExcel.html" class="hover:text-green-700 transition"
            >Edit Excel</a
          >
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main
      class="max-w-3xl mx-auto mt-10 bg-white/90 backdrop-blur-md excel-card rounded-2xl p-8"
    >
      <div class="flex items-center gap-3 mb-4">
        <i
          data-lucide="combine"
          class="w-8 h-8 text-green-600 animate-[float_3s_ease-in-out_infinite]"
        ></i>
        <h2 class="text-2xl font-bold text-green-800">Merge Excel Files</h2>
      </div>
      <p class="text-gray-600 mb-6">
        Combine multiple Excel or CSV files with the same column headers into
        one file. You can reorder or rename before downloading.
      </p>

      <!-- Upload Section -->
      <div class="space-y-4">
        <!-- File Input -->
        <div>
          <label
            class="block text-sm font-semibold text-green-800 mb-1"
            for="files"
          >
            Select Excel/CSV files
          </label>
          <input
            id="files"
            type="file"
            accept=".xlsx,.xls,.csv"
            multiple
            class="block w-full text-sm border rounded-lg p-2 border-green-200 focus:ring-green-400 focus:border-green-400"
          />
        </div>

        <!-- File List -->
        <div id="fileList" class="space-y-2"></div>

        <!-- Sheet Name -->
        <div>
          <label
            class="block text-sm font-semibold text-green-800 mb-1"
            for="sheetName"
          >
            Output Sheet Name
          </label>
          <input
            id="sheetName"
            type="text"
            placeholder="Merged"
            class="w-full border border-green-200 rounded-lg p-2 text-sm focus:ring-green-400 focus:border-green-400"
          />
        </div>

        <!-- Normalize -->
        <div>
          <label class="inline-flex items-center text-sm text-gray-700 gap-2">
            <input
              type="checkbox"
              id="normalizeHeaders"
              checked
              class="rounded text-green-600 focus:ring-green-500"
            />
            Normalize headers (trim + lowercase)
          </label>
        </div>

        <!-- Custom File Name -->
        <div>
          <label
            class="block text-sm font-semibold text-green-800 mb-1"
            for="customName"
          >
            Custom File Name
          </label>
          <input
            id="customName"
            type="text"
            placeholder="Example: NEW_EMPLOYEE"
            class="w-full border border-green-200 rounded-lg p-2 text-sm focus:ring-green-400 focus:border-green-400"
          />
        </div>

        <!-- Merge Button -->
        <button
          id="mergeBtn"
          class="mt-4 px-6 py-3 btn-green font-semibold rounded-lg"
        >
          Merge & Download
        </button>

        <p id="status" class="text-sm text-gray-600 mt-2"></p>
      </div>
    </main>

    <!-- Footer -->
    <footer
      class="text-center text-sm text-gray-500 py-8 mt-12 border-t border-green-100"
    >
      © 2025 <span class="font-semibold excel-green">ILoveExcel</span> — Made
      with 💚 for Excel lovers.
    </footer>

    <!-- Script -->
    <script>
      lucide.createIcons();

      const filesEl = document.getElementById("files");
      const fileList = document.getElementById("fileList");
      const mergeBtn = document.getElementById("mergeBtn");
      const status = document.getElementById("status");
      const sheetNameInput = document.getElementById("sheetName");
      const customNameInput = document.getElementById("customName");
      const normalizeHeadersCheckbox =
        document.getElementById("normalizeHeaders");

      let uploadedFiles = [];

      filesEl.addEventListener("change", (e) => {
        uploadedFiles = Array.from(e.target.files);
        renderFileList();
      });

      function renderFileList() {
        fileList.innerHTML = "";
        uploadedFiles.forEach((file, index) => {
          const div = document.createElement("div");
          div.className =
            "flex items-center justify-between bg-green-50 border border-green-100 rounded-lg p-2 text-sm";
          div.innerHTML = `
            <span>${index + 1}. ${file.name}</span>
            <div class="space-x-1">
              <button class="text-green-600 hover:underline" onclick="moveUp(${index})">↑</button>
              <button class="text-green-600 hover:underline" onclick="moveDown(${index})">↓</button>
              <button class="text-red-500 hover:underline" onclick="removeFile(${index})">✖</button>
            </div>
          `;
          fileList.appendChild(div);
        });
      }

      function moveUp(i) {
        if (i <= 0) return;
        [uploadedFiles[i - 1], uploadedFiles[i]] = [
          uploadedFiles[i],
          uploadedFiles[i - 1],
        ];
        renderFileList();
      }

      function moveDown(i) {
        if (i >= uploadedFiles.length - 1) return;
        [uploadedFiles[i + 1], uploadedFiles[i]] = [
          uploadedFiles[i],
          uploadedFiles[i + 1],
        ];
        renderFileList();
      }

      function removeFile(i) {
        uploadedFiles.splice(i, 1);
        renderFileList();
      }

      function normalize(h) {
        return h == null ? "" : String(h).trim().toLowerCase();
      }

      function readFileAsArrayBuffer(file) {
        return new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = (e) => res(e.target.result);
          r.onerror = (e) => rej(e);
          r.readAsArrayBuffer(file);
        });
      }

      async function parseWorkbook(file) {
        const ab = await readFileAsArrayBuffer(file);
        const wb = XLSX.read(ab, { type: "array" });
        const first = wb.SheetNames[0];
        const sheet = wb.Sheets[first];
        return XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
      }

      mergeBtn.addEventListener("click", async () => {
        if (uploadedFiles.length < 1) {
          status.textContent = "Please select at least one file.";
          return;
        }

        status.textContent = "Reading files...";

        try {
          const allRowsPerFile = [];
          for (const f of uploadedFiles) {
            status.textContent = "Parsing " + f.name + "...";
            const rows = await parseWorkbook(f);
            if (rows.length === 0)
              throw new Error(f.name + " is empty or unreadable.");
            allRowsPerFile.push({ name: f.name, rows });
          }

          const normalizeHeaders = normalizeHeadersCheckbox.checked;
          const headersList = allRowsPerFile.map((x) =>
            x.rows[0].map((h) => (normalizeHeaders ? normalize(h) : h))
          );

          const firstHeaders = headersList[0];
          for (let i = 1; i < headersList.length; i++) {
            const h = headersList[i];
            if (
              h.length !== firstHeaders.length ||
              h.some((val, idx) => val !== firstHeaders[idx])
            ) {
              throw new Error(
                "Header mismatch between files. Check column names.\nFile: " +
                  allRowsPerFile[i].name
              );
            }
          }

          const merged = [allRowsPerFile[0].rows[0]];
          for (const f of allRowsPerFile) {
            const r = f.rows.slice(1);
            for (const row of r) merged.push(row);
          }

          status.textContent = "Creating workbook...";
          const ws = XLSX.utils.aoa_to_sheet(merged);
          const wbout = XLSX.utils.book_new();
          const outName =
            (sheetNameInput.value || "Merged").replace(/[^a-z0-9_-]/gi, "") ||
            "Merged";
          XLSX.utils.book_append_sheet(wbout, ws, outName);

          const fileNameBase =
            customNameInput.value.trim() || "ILoveExcel_Merged";
          const date = new Date();
          const timestamp = `${date.getFullYear()}-${String(
            date.getMonth() + 1
          ).padStart(2, "0")}-${String(date.getDate()).padStart(
            2,
            "0"
          )}_${String(date.getHours()).padStart(2, "0")}${String(
            date.getMinutes()
          ).padStart(2, "0")}${String(date.getSeconds()).padStart(2, "0")}`;
          const fileName = `${fileNameBase}_${timestamp}.xlsx`;

          const wbBlob = workbookToBlob(wbout);
          triggerDownload(wbBlob, fileName);
          status.textContent = "✅ Done — downloaded " + fileName;
        } catch (err) {
          console.error(err);
          status.textContent = "❌ Error: " + (err.message || err);
        }
      });

      function workbookToBlob(wb) {
        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        return new Blob([wbout], { type: "application/octet-stream" });
      }

      function triggerDownload(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 5000);
      }
    </script>
  </body>
</html>
